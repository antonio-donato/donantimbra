<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timbratura Presenze</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #0b0c0f;
      --card: #151823;
      --text: #e9eef5;
      --muted: #9aa6b2;
      --brand: #4f8cff;
      --ok: #14b8a6;
      --warn: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --radius: 16px;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f8fb;
        --card: #ffffff;
        --text: #0b0c0f;
        --muted: #4b5563;
        --brand: #2563eb;
      }
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 24px;
      display: grid;
      gap: 16px;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; flex-wrap: wrap;
    }
    .brand {
      display: flex; align-items: center; gap: 12px;
      font-weight: 700; font-size: 1.2rem;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .controls {
      display: grid; grid-template-columns: 1fr; gap: 12px;
    }
    @media (min-width: 640px) {
      .controls { grid-template-columns: 1fr 1fr; }
    }
    button {
      appearance: none; border: 0; border-radius: 12px;
      padding: 14px 16px; font-weight: 700; cursor: pointer;
      transition: transform .02s ease, filter .2s ease, opacity .2s ease;
      background: var(--brand); color: white;
    }
    button.secondary { background: #334155; }
    button.ghost {
      background: transparent; color: var(--text);
      border: 1px solid #303643;
    }
    button:disabled { opacity: 0.55; cursor: not-allowed; filter: grayscale(0.2); }
    .status {
      display: flex; align-items: center; gap: 10px; font-size: 0.95rem;
    }
    .badge {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: .85rem;
    }
    .badge.ok { background: color-mix(in oklab, var(--ok) 26%, transparent); color: var(--ok); border: 1px solid color-mix(in oklab, var(--ok) 40%, transparent); }
    .badge.muted { background: #293141; color: var(--muted); border: 1px solid #3a4252; }
    .timer {
      font-variant-numeric: tabular-nums;
      font-weight: 800; letter-spacing: .5px; font-size: 1.15rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    th, td {
      border-bottom: 1px solid #2a3140;
      padding: 12px 8px; text-align: left;
      white-space: nowrap;
    }
    th { color: var(--muted); font-weight: 600; }
    tbody tr:hover { background: rgba(255,255,255,.03); }
    .muted { color: var(--muted); }
    .row {
      display: grid; grid-template-columns: 1fr; gap: 12px;
    }
    @media (min-width: 840px) {
      .row { grid-template-columns: 1.1fr .9fr; }
    }
    .right { display: grid; gap: 12px; align-content: start; }
    .danger { background: var(--danger); }
    .warn { background: var(--warn); }
    .ok { background: var(--ok); }
    footer { text-align: center; color: var(--muted); font-size: .85rem; padding: 12px 0 24px; }
    .hidden { display: none !important; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
        </svg>
        Timbratura Presenze
      </div>
      <div id="userBox" class="status">
        <span id="userName" class="muted">Non autenticato</span>
        <button id="btnLogin">Accedi con Google</button>
        <button id="btnLogout" class="ghost hidden">Logout</button>
      </div>
    </header>

    <div id="authGuard" class="card">
      <div class="status">
        <span class="badge muted">Accesso richiesto</span>
        <span>Accedi con Google per iniziare la timbratura.</span>
      </div>
    </div>

    <div id="app" class="hidden">
      <div class="row">
        <section class="card">
          <h2 style="margin:4px 0 12px;">Oggi <span id="todayLabel" class="muted"></span></h2>
          <div class="controls" style="margin-bottom: 8px;">
            <button id="btnCheckIn" class="ok">Timbratura ingresso</button>
            <button id="btnCheckOut" class="warn" disabled>Timbratura uscita</button>
          </div>
          <div class="status" style="justify-content: space-between; flex-wrap: wrap;">
            <div>
              <span id="statusBadge" class="badge muted">Assente</span>
            </div>
            <div>
              <span class="muted">Tempo dalla timbratura:</span>
              <span id="liveTimer" class="timer">—:—:—</span>
            </div>
          </div>
        </section>

        <aside class="right">
          <div class="card">
            <strong>Riepilogo utente</strong>
            <div class="muted" style="margin-top:6px;">
              <div>UID: <span id="uid" class="mono">—</span></div>
              <div>Email: <span id="email" class="mono">—</span></div>
            </div>
          </div>
          <div class="card">
            <strong>Note</strong>
            <ul class="muted" style="margin-top:6px; padding-left: 16px;">
              <li>Orario registrato con <em>serverTimestamp</em> (ora lato server).</li>
              <li>Un solo turno aperto alla volta.</li>
              <li>Solo tu puoi vedere/modificare i tuoi dati.</li>
            </ul>
          </div>
        </aside>
      </div>

      <section class="card">
        <h3 style="margin:4px 0 12px;">Timbrature di oggi</h3>
        <div class="muted" id="emptyState">Nessuna timbratura per oggi.</div>
        <div class="tablewrap">
          <table id="tbl">
            <thead>
              <tr>
                <th>#</th>
                <th>Ingresso</th>
                <th>Uscita</th>
                <th>Durata</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <footer>© <span id="year"></span> Timbratura Presenze</footer>
  </div>

  <!-- Firebase v9+ modular via CDN -->
  <script type="module">
    // ====== CONFIGURAZIONE FIREBASE ======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, collection, getDoc, setDoc, updateDoc, addDoc, onSnapshot,
      serverTimestamp, query, orderBy, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
    apiKey: "",
    authDomain: "timbrature-prod.firebaseapp.com",
    projectId: "timbrature-prod",
    storageBucket: "timbrature-prod.firebasestorage.app",
    messagingSenderId: "33404456206",
    appId: "1:33404456206:web:f62ec82086d02e91535b5f",
    measurementId: "G-DT5FMM2PC4"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    // ====== ELEMENTI UI ======
    const el = (id) => document.getElementById(id);
    const yearEl = el("year");
    yearEl.textContent = new Date().getFullYear();

    const authGuard = el("authGuard");
    const appView = el("app");
    const btnLogin = el("btnLogin");
    const btnLogout = el("btnLogout");
    const userName = el("userName");
    const uidEl = el("uid");
    const emailEl = el("email");
    const statusBadge = el("statusBadge");
    const liveTimer = el("liveTimer");
    const btnCheckIn = el("btnCheckIn");
    const btnCheckOut = el("btnCheckOut");
    const tbody = el("tbody");
    const emptyState = el("emptyState");
    const todayLabel = el("todayLabel");

    // ====== UTILS DATA ======
    // Usa il fuso orario locale del dispositivo per "etichettare" il giorno.
    function pad(n) { return n.toString().padStart(2, "0"); }
    function dateKey(d = new Date()) {
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; // YYYY-MM-DD
    }
    function fmtTime(ts) {
      if (!ts) return "—";
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function humanDuration(ms) {
      if (ms == null) return "—";
      const s = Math.floor(ms / 1000);
      const hh = Math.floor(s / 3600);
      const mm = Math.floor((s % 3600) / 60);
      const ss = s % 60;
      return `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
    }

    todayLabel.textContent = `(${dateKey()})`;

    // ====== RIFERIMENTI FIRESTORE ======
    // Schema:
    // users/{uid}/days/{YYYY-MM-DD} -> { openSessionId: string|null }
    // users/{uid}/days/{YYYY-MM-DD}/sessions/{autoId} -> { in: Timestamp, out: Timestamp|null }
    function dayDocRef(uid, key = dateKey()) {
      return doc(db, "users", uid, "days", key);
    }
    function sessionsColRef(uid, key = dateKey()) {
      return collection(db, "users", uid, "days", key, "sessions");
    }

    // ====== STATO E TIMER ======
    let unsubSessions = null;
    let currentUser = null;
    let currentOpenInMillis = null;
    let timerHandle = null;

    function setStatus(present) {
      if (present) {
        statusBadge.textContent = "Presente";
        statusBadge.className = "badge ok";
        btnCheckIn.disabled = true;
        btnCheckOut.disabled = false;
      } else {
        statusBadge.textContent = "Assente";
        statusBadge.className = "badge muted";
        btnCheckIn.disabled = false;
        btnCheckOut.disabled = true;
      }
    }

    function startTimer(fromMillis) {
      stopTimer();
      currentOpenInMillis = fromMillis;
      timerHandle = setInterval(() => {
        const now = Date.now();
        liveTimer.textContent = humanDuration(now - currentOpenInMillis);
      }, 1000);
      liveTimer.textContent = humanDuration(Date.now() - currentOpenInMillis);
    }
    function stopTimer() {
      if (timerHandle) clearInterval(timerHandle);
      timerHandle = null;
      currentOpenInMillis = null;
      liveTimer.textContent = "—:—:—";
    }

    // ====== LOGIN/LOGOUT ======
    btnLogin.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, googleProvider);
      } catch (e) {
        alert("Accesso annullato o non riuscito.");
        console.error(e);
      }
    });
    btnLogout.addEventListener("click", async () => {
      try { await signOut(auth); } catch (e) { console.error(e); }
    });

    // ====== PUNCH IN/OUT (TRANSAZIONI) ======
    btnCheckIn.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      const dRef = dayDocRef(user.uid);
      const sCol = sessionsColRef(user.uid);
      try {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(dRef);
          const openId = snap.exists() ? snap.data().openSessionId ?? null : null;
          if (openId) throw new Error("C'è già un turno aperto. Aggiorna la pagina.");
          // crea nuova sessione con IN
          const newSessRef = await addDoc(sCol, { in: serverTimestamp(), out: null });
          // crea/aggiorna il doc del giorno con openSessionId
          if (!snap.exists()) {
            tx.set(dRef, { openSessionId: newSessRef.id, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
          } else {
            tx.update(dRef, { openSessionId: newSessRef.id, updatedAt: serverTimestamp() });
          }
        });
      } catch (e) {
        console.error(e);
        alert(e.message || "Errore timbratura ingresso.");
      }
    });

    btnCheckOut.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      const dRef = dayDocRef(user.uid);
      try {
        await runTransaction(db, async (tx) => {
          const dSnap = await tx.get(dRef);
          if (!dSnap.exists()) throw new Error("Nessuna sessione aperta.");
          const openId = dSnap.data().openSessionId ?? null;
          if (!openId) throw new Error("Nessuna sessione aperta.");
          const sRef = doc(db, dRef.path, "sessions", openId);
          const sSnap = await tx.get(sRef);
          if (!sSnap.exists()) throw new Error("Sessione non trovata.");
          if (sSnap.data().out) throw new Error("La sessione risulta già chiusa.");
          tx.update(sRef, { out: serverTimestamp() });
          tx.update(dRef, { openSessionId: null, updatedAt: serverTimestamp() });
        });
      } catch (e) {
        console.error(e);
        alert(e.message || "Errore timbratura uscita.");
      }
    });

    // ====== SUBSCRIBE TIMBRATURE DI OGGI ======
    async function listenToday(uid) {
      if (unsubSessions) { unsubSessions(); unsubSessions = null; }
      const dRef = dayDocRef(uid);
      const q = query(sessionsColRef(uid), orderBy("in", "asc"));
      unsubSessions = onSnapshot(q, async (qs) => {
        const dSnap = await getDoc(dRef); // doc giorno per openSessionId
        const openId = dSnap.exists() ? dSnap.data().openSessionId ?? null : null;

        // render tabella
        tbody.innerHTML = "";
        let rows = 0;
        let openInMillis = null;

        qs.forEach((docSnap, idx) => {
          const data = docSnap.data();
          const tr = document.createElement("tr");
          const inTime = data.in ?? null;
          const outTime = data.out ?? null;

          const tdIdx = document.createElement("td");
          tdIdx.textContent = String(idx + 1);

          const tdIn = document.createElement("td");
          tdIn.textContent = inTime ? fmtTime(inTime) : "—";

          const tdOut = document.createElement("td");
          tdOut.textContent = outTime ? fmtTime(outTime) : "—";

          const tdDur = document.createElement("td");
          if (inTime && outTime) {
            tdDur.textContent = humanDuration(outTime.toDate() - inTime.toDate());
          } else if (inTime && docSnap.id === openId) {
            // sessione aperta -> durata parziale in tempo reale
            tdDur.textContent = "in corso…";
            openInMillis = inTime.toDate().getTime();
          } else {
            tdDur.textContent = "—";
          }

          tr.append(tdIdx, tdIn, tdOut, tdDur);
          tbody.appendChild(tr);
          rows++;
        });

        emptyState.style.display = rows === 0 ? "block" : "none";

        // stato e timer
        const present = !!openId;
        setStatus(present);
        if (present && openInMillis) startTimer(openInMillis); else stopTimer();
      });
    }

    // ====== AUTH STATE ======
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (!user) {
        // logged out
        authGuard.classList.remove("hidden");
        appView.classList.add("hidden");
        userName.textContent = "Non autenticato";
        uidEl.textContent = "—";
        emailEl.textContent = "—";
        btnLogin.classList.remove("hidden");
        btnLogout.classList.add("hidden");
        stopTimer();
        if (unsubSessions) unsubSessions();
        return;
      }
      // logged in
      authGuard.classList.add("hidden");
      appView.classList.remove("hidden");
      userName.textContent = user.displayName ?? user.email ?? "Utente";
      uidEl.textContent = user.uid;
      emailEl.textContent = user.email ?? "—";
      btnLogin.classList.add("hidden");
      btnLogout.classList.remove("hidden");
      listenToday(user.uid);
    });

    // Evita doppio submit sui pulsanti
    function lockButtons(lock = true) {
      btnCheckIn.disabled = lock || btnCheckIn.disabled;
      btnCheckOut.disabled = lock || btnCheckOut.disabled;
      setTimeout(() => {}, 200);
    }
  </script>
</body>
</html>


